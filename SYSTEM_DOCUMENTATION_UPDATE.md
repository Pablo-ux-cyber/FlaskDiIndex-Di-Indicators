# Обновление системной документации

## Обработка исторических 4-часовых данных

В систему добавлена поддержка отображения 4-часовых данных для всего исторического периода. Раньше 4-часовые данные отображались только для последних ~5.5 месяцев (2000 точек), доступных через API CryptoCompare. Теперь реализована следующая логика:

1. Все 4-часовые значения (поле `4h_values_new`) сохраняются в файлах истории DI индекса (`[SYMBOL]_di_combined_history.json`)
2. При запросе данных с параметром `use_history=true` (по умолчанию включен), API объединяет актуальные данные с историческими
3. Для каждого дня мы сохраняем массив всех 4-часовых значений, что позволяет видеть детальную динамику внутри дня
4. В таблице используется последнее 4-часовое значение дня (20:00 UTC) для отображения в колонке "4h"

### Обратная совместимость

Для обеспечения обратной совместимости со старыми файлами истории, которые не содержат полного поля `4h_values_new`, реализован следующий механизм:

1. Если запись из истории содержит только поле `4h_di_new`, но не содержит `4h_values_new`, создается синтетическое поле `4h_values_new` с одним значением, соответствующим последней 4-часовой свече дня (20:00 UTC)
2. Это обеспечивает корректное отображение исторических 4-часовых данных даже для старых записей

### API-параметры

- `use_history=true|false` - включить/выключить использование исторических данных (по умолчанию true)

### Формат данных

Пример записи в файле истории:

```json
"2025-04-25": {
  "time": "2025-04-25",
  "daily_di_new": 15,
  "weekly_di_new": 6,
  "4h_values_new": [
    {
      "time": "2025-04-25 00:00:00",
      "value_new": 12
    },
    {
      "time": "2025-04-25 04:00:00",
      "value_new": 13
    },
    {
      "time": "2025-04-25 08:00:00",
      "value_new": 13
    },
    {
      "time": "2025-04-25 12:00:00",
      "value_new": 14
    },
    {
      "time": "2025-04-25 16:00:00",
      "value_new": 14
    },
    {
      "time": "2025-04-25 20:00:00",
      "value_new": 15
    }
  ],
  "4h_di_new": 15,
  "total_new": 36,
  "di_ema_13_new": 24.5,
  "di_sma_30_new": 19.8,
  "trend_new": "bullish",
  "open": 67853.23,
  "close": 68102.47
}
```

## Рекомендации по дальнейшему улучшению

1. Для полной обратной совместимости можно перезапустить `daily_update.py` с добавлением флага для пересохранения всей истории в новом формате с полным сохранением `4h_values_new`
2. Оптимизировать предупреждения pandas о замене значений в копиях DataFrame (FutureWarning)