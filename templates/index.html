<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>DI Index – Объединённые данные</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { font-family: Arial, sans-serif; }
    .coin-container { margin-bottom: 40px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; position: sticky; top: 0; z-index: 1; cursor: pointer; }
    th:hover { background-color: #e6e6e6; }
    tr:hover { background-color: #e0f7fa; }
    tr.no-4h { background-color: #fff3e0; }
    tr.no-4h:hover { background-color: #ffe0b2; }
    caption { margin-bottom: 10px; font-size: 1.4em; font-weight: bold; }
    #error { color: red; font-weight: bold; margin-top: 20px; white-space: pre-wrap; }
    .symbol-selector { margin: 20px 0; }
    #loading { font-size: 1.2em; margin: 20px 0; }
    select[multiple] { min-width: 200px; height: 300px; }
    .loading-indicator { color: #666; font-style: italic; margin-left: 10px; }
    .control-buttons { margin: 10px 0; }
    .btn { 
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #6c757d;
      color: white;
    }
    .btn:hover {
      background-color: #5a6268;
    }
    .diff-highlight {
      background-color: rgba(255, 244, 229, 0.3);
    }
    .comparison-group {
      border-right: 2px solid #ddd;
    }
    thead tr th.group-header {
      text-align: center;
      background-color: #e9ecef;
      font-weight: bold;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>DI Index – Объединённые данные</h1>

  <div class="symbol-selector">
    <label for="symbols">Выберите криптовалюты:</label>
    <select id="symbols" multiple>
      <option value="BTC" selected>Биткоин (BTC)</option>
      <option value="ETH">Эфириум (ETH)</option>
      <option value="XRP">XRP (XRP)</option>
      <option value="BNB">BNB (BNB)</option>
      <option value="SOL">Solana (SOL)</option>
      <option value="ADA">Кардано (ADA)</option>
      <option value="CRO">Cronos (CRO)</option>
      <option value="DOGE">Dogecoin (DOGE)</option>
      <option value="TRX">TRON (TRX)</option>
      <option value="LEO">LEO Token (LEO)</option>
      <option value="HBAR">Hedera (HBAR)</option>
      <option value="LINK">Chainlink (LINK)</option>
      <option value="XLM">Stellar (XLM)</option>
      <option value="AVAX">Avalanche (AVAX)</option>
      <option value="SUI">Sui (SUI)</option>
      <option value="SHIB">Shiba Inu (SHIB)</option>
      <option value="LTC">Лайткоин (LTC)</option>
      <option value="BCH">Биткойн Кэш (BCH)</option>
      <option value="TON">Toncoin (TON)</option>
      <option value="OM">MANTRA OM (OM)</option>
      <option value="DOT">Polkadot (DOT)</option>
      <option value="BGB">Bitget Token (BGB)</option>
      <option value="HYPE">Hyperliquid (HYPE)</option>
      <option value="WBT">WhiteBIT Coin (WBT)</option>
      <option value="XMR">Монеро (XMR)</option>
      <option value="UNI">Uniswap (UNI)</option>
      <option value="APT">Aptos (APT)</option>
      <option value="NEAR">NEAR Protocol (NEAR)</option>
      <option value="AAVE">Aave (AAVE)</option>
      <option value="ETC">Ethereum Classic (ETC)</option>
    </select>
    <div class="control-buttons">
      <button onclick="selectAll()">Выбрать все</button>
      <button onclick="deselectAll()">Отменить выбор</button>
      <button onclick="loadSelectedData()">Загрузить данные</button>
    </div>
    <div id="loading" style="display: none;">
      Загрузка данных...<span class="loading-indicator"></span>
      <div id="progress"></div>
    </div>
  </div>

  <div id="error"></div>

  <div class="market-sentiment">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2>Общее настроение рынка</h2>
      <button class="btn btn-sm btn-secondary" onclick="downloadMarketSentimentExcel()">Экспорт в Excel</button>
    </div>
    <table class="sentiment-table">
      <thead>
        <tr>
          <th>Дата</th>
          <th>Количество бычьих сигналов</th>
          <th>Всего монет с данными</th>
          <th>Процент бычьих сигналов</th>
          <th>13 EMA (%)</th>
          <th>13 SMA (%)</th>
        </tr>
      </thead>
      <tbody id="sentimentTableBody">
      </tbody>
    </table>
  </div>

  <div id="tables-container">
    <!-- Таблицы будут добавлены здесь -->
  </div>

  <script>
    function formatValue(val) {
      return (val === null || isNaN(val)) ? '-' : Number(val).toFixed(2);
    }

    function show4hValues(values, date) {
      console.log("4h values:", values, "date:", date); // Debugging
      const modalContent = `
        <div class="modal" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">4h значения за ${date}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Время</th>
                      <th>Старый метод</th>
                      <th>Новый метод</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${values.map(entry => `
                      <tr>
                        <td>${entry.time}</td>
                        <td>${formatValue(entry.value_old)}</td>
                        <td>${formatValue(entry.value_new)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;

      const modalEl = $(modalContent);
      modalEl.modal('show');
      modalEl.on('hidden.bs.modal', function () {
        modalEl.remove();
      });
    }

    function get4hValuesForDate(row) {
      try {
        console.log("Row data:", row); // Debugging
        // Проверяем наличие массивов 4h_values
        if (!row['4h_values_old'] || !row['4h_values_new']) {
          console.error("Missing 4h values arrays");
          return [];
        }

        // Combine old and new values
        const times = new Set([
          ...row['4h_values_old'].map(v => v.time),
          ...row['4h_values_new'].map(v => v.time)
        ]);

        return Array.from(times).map(time => ({
          time,
          value_old: (row['4h_values_old'].find(v => v.time === time) || {}).value,
          value_new: (row['4h_values_new'].find(v => v.time === time) || {}).value
        })).sort((a, b) => a.time.localeCompare(b.time));
      } catch (error) {
        console.error("Error in get4hValuesForDate:", error);
        return [];
      }
    }

    function selectAll() {
      const symbolsSelect = document.getElementById('symbols');
      for (let option of symbolsSelect.options) {
        option.selected = true;
      }
    }

    function deselectAll() {
      const symbolsSelect = document.getElementById('symbols');
      for (let option of symbolsSelect.options) {
        option.selected = false;
      }
    }

    function sortTable(table, columnIndex) {
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const isNumeric = columnIndex > 0;

      rows.sort((a, b) => {
        let aVal = a.cells[columnIndex].textContent;
        let bVal = b.cells[columnIndex].textContent;

        if (isNumeric) {
          aVal = aVal === '-' ? -Infinity : parseFloat(aVal);
          bVal = bVal === '-' ? -Infinity : parseFloat(bVal);
        }

        if (aVal < bVal) return -1;
        if (aVal > bVal) return 1;
        return 0;
      });

      const currentDir = table.getAttribute('data-sort-dir') === 'asc' ? 'desc' : 'asc';
      table.setAttribute('data-sort-dir', currentDir);

      if (currentDir === 'desc') {
        rows.reverse();
      }

      tbody.innerHTML = '';
      rows.forEach(row => tbody.appendChild(row));
    }

    function calculateMarketSentiment(allData) {
      const sentimentByDate = {};

      // Собираем данные по датам
      for (const [symbol, data] of Object.entries(allData)) {
        if (!Array.isArray(data)) continue;

        data.forEach(row => {
          const date = row.time;
          if (!sentimentByDate[date]) {
            sentimentByDate[date] = { bullCount: 0, totalCount: 0 };
          }
          if (row.trend !== null) {
            sentimentByDate[date].totalCount++;
            if (row.trend === 'bull') {
              sentimentByDate[date].bullCount++;
            }
          }
        });
      }

      // Преобразуем в массив и сортируем по дате
      const sortedData = Object.entries(sentimentByDate)
        .map(([date, data]) => ({
          date,
          bullCount: data.bullCount,
          totalCount: data.totalCount,
          percentage: (data.bullCount / data.totalCount * 100).toFixed(2)
        }))
        .sort((a, b) => a.date.localeCompare(b.date));

      // Рассчитываем 13MA для процентов
      const percentages = sortedData.map(item => parseFloat(item.percentage));
      const ma13 = [];
      const sma13 = [];
      const alpha = 2 / (13 + 1); // коэффициент для 13 EMA

      // Сначала считаем EMA по хронологии
      for (let i = 0; i < percentages.length; i++) {
        if (isNaN(percentages[i])) {
          ma13.push(null);
          sma13.push(null);
        } else if (i === 0) {
          ma13.push(parseFloat(percentages[i]));
          sma13.push(parseFloat(percentages[i]));
        } else {
          // Расчет EMA
          const prevEMA = ma13[i - 1];
          if (prevEMA === null || isNaN(prevEMA)) {
            ma13.push(parseFloat(percentages[i]));
          } else {
            const ema = (percentages[i] * alpha) + (prevEMA * (1 - alpha));
            ma13.push(ema);
          }

          // Расчет SMA
          const start = Math.max(0, i - 12);
          const slice = percentages.slice(start, i + 1);
          const validNumbers = slice.filter(n => !isNaN(n));
          sma13.push(validNumbers.length > 0 ? 
            validNumbers.reduce((a, b) => a + b, 0) / validNumbers.length : 
            null
          );
        }
      }

      // Добавляем MA13 к данным и сортируем по убыванию дат
      return sortedData.map((item, index) => ({
        ...item,
        ma13: ma13[index] === null ? null : ma13[index].toFixed(2),
        sma13: sma13[index] === null ? null : sma13[index].toFixed(2)
      })).reverse(); // Разворачиваем для отображения новых данных сверху
    }

    function updateSentimentTable(sentimentData) {
      const tbody = document.getElementById('sentimentTableBody');
      tbody.innerHTML = sentimentData.map(row => `
        <tr>
          <td>${row.date}</td>
          <td>${row.bullCount}</td>
          <td>${row.totalCount}</td>
          <td>${row.percentage}%</td>
          <td>${row.ma13 !== null ? row.ma13 + '%' : '-'}</td>
          <td>${row.sma13 !== null ? row.sma13 + '%' : '-'}</td>
        </tr>
      `).join('');
    }

    function downloadExcel(data, symbol) {
      // Форматируем данные для Excel
      const rows = [
        ['Дата', 
         'Weekly DI (Old)', 'Weekly DI (New)',
         'Daily DI (Old)', 'Daily DI (New)',
         '4h DI (Old)', '4h DI (New)',
         'DI Index (Old)', '13 EMA (Old)', '30 SMA (Old)', 'Trend (Old)',
         'DI Index (New)', '13 EMA (New)', '30 SMA (New)', 'Trend (New)',
         'Close (Daily)']
      ];

      data.forEach(row => {
        rows.push([
          row.time,
          formatValue(row.weekly_di_old),
          formatValue(row.weekly_di_new),
          formatValue(row.daily_di_old),
          formatValue(row.daily_di_new),
          formatValue(row['4h_di_old']),
          formatValue(row['4h_di_new']),
          formatValue(row.DI_index_old),
          formatValue(row.di_ema_13_old),
          formatValue(row.di_sma_30_old),
          row.trend_old || '-',
          formatValue(row.DI_index_new),
          formatValue(row.di_ema_13_new),
          formatValue(row.di_sma_30_new),
          row.trend_new || '-',
          formatValue(row.close)
        ]);
      });

      // Создаем Workbook
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);

      // Добавляем worksheet в workbook
      XLSX.utils.book_append_sheet(wb, ws, symbol);

      // Сохраняем файл
      XLSX.writeFile(wb, `${symbol}_DI_Index_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function compareValues(val1, val2) {
      if (val1 === null || val2 === null || isNaN(val1) || isNaN(val2)) return false;
      return Math.abs(val1 - val2) > 0.01; // Различие больше 0.01 считаем значимым
    }

    function createTable(symbol, data) {
      const container = document.createElement('div');
      container.className = 'coin-container';

      // Добавляем кнопку экспорта
      const exportButton = document.createElement('button');
      exportButton.className = 'btn btn-sm btn-secondary';
      exportButton.innerHTML = 'Экспорт в Excel';
      exportButton.onclick = () => downloadExcel(data, symbol);

      const headerDiv = document.createElement('div');
      headerDiv.style.display = 'flex';
      headerDiv.style.justifyContent = 'space-between';
      headerDiv.style.alignItems = 'center';
      headerDiv.style.marginBottom = '10px';

      const title = document.createElement('h3');
      title.textContent = `${symbol} - DI Index`;

      headerDiv.appendChild(title);
      headerDiv.appendChild(exportButton);
      container.appendChild(headerDiv);

      const table = document.createElement('table');
      table.setAttribute('data-sort-dir', 'asc');

      table.innerHTML = `
        <thead>
          <tr>
            <th rowspan="3">Дата</th>
            <th colspan="6" class="group-header comparison-group">DI Компоненты</th>
            <th colspan="4" class="group-header comparison-group">Старый метод</th>
            <th colspan="4" class="group-header">Новый метод</th>
            <th rowspan="3">Close (Daily)</th>
          </tr>
          <tr>
            <th colspan="2">Weekly</th>
            <th colspan="2">Daily</th>
            <th colspan="2" class="comparison-group">4h</th>
            <th colspan="4" class="group-header comparison-group">Расчет</th>
            <th colspan="4" class="group-header">Расчет</th>
          </tr>
          <tr>
            <th>Old</th>
            <th>New</th>
            <th>Old</th>
            <th>New</th>
            <th>Old</th>
            <th class="comparison-group">New</th>
            <th>DI Index</th>
            <th>13 EMA</th>
            <th>30 SMA</th>
            <th class="comparison-group">Trend</th>
            <th>DI Index</th>
            <th>13 EMA</th>
            <th>30 SMA</th>
            <th>Trend</th>
          </tr>
        </thead>
        <tbody>
          ${data.map(row => {
            const weekly_diff = compareValues(row.weekly_di_old, row.weekly_di_new);
            const daily_diff = compareValues(row.daily_di_old, row.daily_di_new);
            const fourh_diff = compareValues(row['4h_di_old'], row['4h_di_new']);
            const di_diff = compareValues(row.DI_index_old, row.DI_index_new);
            const ema_diff = compareValues(row.di_ema_13_old, row.di_ema_13_new);
            const sma_diff = compareValues(row.di_sma_30_old, row.di_sma_30_new);
            const trend_diff = row.trend_old !== row.trend_new;

            // Convert 4h values to a string for the onclick handler
            const values4h = JSON.stringify(get4hValuesForDate(row)).replace(/'/g, "\\'");

            return `
              <tr>
                <td>${row.time}</td>
                <td class="${weekly_diff ? 'diff-highlight' : ''}">${formatValue(row.weekly_di_old)}</td>
                <td class="${weekly_diff ? 'diff-highlight' : ''}">${formatValue(row.weekly_di_new)}</td>
                <td class="${daily_diff ? 'diff-highlight' : ''}">${formatValue(row.daily_di_old)}</td>
                <td class="${daily_diff ? 'diff-highlight' : ''}">${formatValue(row.daily_di_new)}</td>
                <td class="${fourh_diff ? 'diff-highlight' : ''}" style="cursor: pointer" onclick='show4hValues(${values4h}, "${row.time}")'>${formatValue(row['4h_di_old'])}</td>
                <td class="${fourh_diff ? 'diff-highlight' : ''} comparison-group" style="cursor: pointer" onclick='show4hValues(${values4h}, "${row.time}")'>${formatValue(row['4h_di_new'])}</td>
                <td class="${di_diff ? 'diff-highlight' : ''}">${formatValue(row.DI_index_old)}</td>
                <td class="${ema_diff ? 'diff-highlight' : ''}">${formatValue(row.di_ema_13_old)}</td>
                <td class="${sma_diff ? 'diff-highlight' : ''}">${formatValue(row.di_sma_30_old)}</td>
                <td class="${trend_diff ? 'diff-highlight' : ''} comparison-group">
                  ${row.trend_old ? (row.trend_old === 'bull' ? '<span style="color:green;">bull</span>' : '<span style="color:red;">bear</span>') : '-'}
                </td>
                <td class="${di_diff ? 'diff-highlight' : ''}">${formatValue(row.DI_index_new)}</td>
                <td class="${ema_diff ? 'diff-highlight' : ''}">${formatValue(row.di_ema_13_new)}</td>
                <td class="${sma_diff ? 'diff-highlight' : ''}">${formatValue(row.di_sma_30_new)}</td>
                <td class="${trend_diff ? 'diff-highlight' : ''}">
                  ${row.trend_new ? (row.trend_new === 'bull' ? '<span style="color:green;">bull</span>' : '<span style="color:red;">bear</span>') : '-'}
                </td>
                <td>${formatValue(row.close)}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      `;

      container.appendChild(table);
      return container;
    }

    function batchProcess(symbols, batchSize = 5) {
      const batches = [];
      for (let i = 0; i < symbols.length; i += batchSize) {
        batches.push(symbols.slice(i, i + batchSize));
      }
      return batches;
    }

    async function loadSelectedData() {
      const loadingDiv = document.getElementById('loading');
      const progressDiv = document.getElementById('progress');
      const errorDiv = document.getElementById('error');
      const container = document.getElementById('tables-container');

      try {
        loadingDiv.style.display = 'block';
        errorDiv.textContent = '';
        container.innerHTML = '';

        const symbolsSelect = document.getElementById('symbols');
        const selectedSymbols = Array.from(symbolsSelect.selectedOptions).map(option => option.value);

        if (selectedSymbols.length === 0) {
          throw new Error('Пожалуйста, выберите хотя бы одну криптовалюту');
        }

        const batches = batchProcess(selectedSymbols, 3); // Уменьшаем размер пакета до 3
        let successCount = 0;
        let errorCount = 0;
        let allData = {};

        for (let i = 0; i < batches.length; i++) {
          const batch = batches[i];
          progressDiv.textContent = `Загрузка пакета ${i + 1} из ${batches.length} (${batch.join(', ')})...`;

          // Добавляем механизм повторных попыток
          let retryCount = 0;
          const maxRetries = 3;

          while (retryCount < maxRetries) {
            try {
              const response = await fetch(`/api/di_index?symbols=${batch.join(',')}`);
              if (!response.ok) {
                if (response.status === 502) {
                  throw new Error('Сервер временно недоступен, повторная попытка...');
                }
                throw new Error(`Ошибка HTTP: ${response.status}`);
              }

              const json = await response.json();
              Object.assign(allData, json);

              for (const [symbol, data] of Object.entries(json)) {
                if (Array.isArray(data)) {
                  container.appendChild(createTable(symbol, data));
                  successCount++;
                } else if (data.error) {
                  console.error(`Ошибка для ${symbol}:`, data.error);
                  errorDiv.textContent += `Ошибка для ${symbol}: ${data.error}\n`;
                  errorCount++;
                }
              }
              break; // Успешно получили данные, выходим из цикла повторных попыток

            } catch (error) {
              retryCount++;
              if (retryCount === maxRetries) {
                console.error(`Ошибка обработки пакета ${i + 1} после ${maxRetries} попыток:`, error);
                errorDiv.textContent += `Ошибка в пакете ${i + 1} (${batch.join(', ')}): ${error.message}\n`;
                errorCount += batch.length;
              } else {
                console.log(`Попытка ${retryCount} из ${maxRetries} для пакета ${i + 1}...`);
                await new Promise(resolve => setTimeout(resolve, 1000 * retryCount)); // Увеличиваем задержку с каждой попыткой
              }
            }
          }
        }

        // Обновляем таблицу настроения рынка только если есть успешно загруженные данные
        if (Object.keys(allData).length > 0) {
          const sentimentData = calculateMarketSentiment(allData);
          updateSentimentTable(sentimentData);
        }

        progressDiv.textContent = `Загружено успешно: ${successCount} монет, с ошибками: ${errorCount} монет`;

      } catch (error) {
        console.error("Ошибка загрузки данных:", error);
        errorDiv.textContent = `Ошибка загрузки данных: ${error.message}`;
        progressDiv.textContent = '';
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Загружаем данные при загрузке страницы
    window.onload = loadSelectedData;


    function downloadMarketSentimentExcel() {
      // Форматируем данные для Excel
      const rows = [
        ['Дата', 'Количество бычьих сигналов', 'Всего монет с данными', 'Процент бычьих сигналов', '13 EMA (%)', '13 SMA (%)']
      ];

      // Получаем данные из таблицы
      const tbody = document.getElementById('sentimentTableBody');
      const tableRows = tbody.getElementsByTagName('tr');

      Array.from(tableRows).forEach(row => {
        const cells = row.getElementsByTagName('td');
        rows.push([
          cells[0].textContent, // Дата
          cells[1].textContent, // Количество бычьих сигналов
          cells[2].textContent, // Всего монет
          cells[3].textContent, // Процент
          cells[4].textContent, // 13 EMA
          cells[5].textContent  // 13 SMA
        ]);
      });

      // Создаем Workbook
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);

      // Добавляем worksheet в workbook
      XLSX.utils.book_append_sheet(wb, ws, "Market Sentiment");

      // Сохраняем файл
      XLSX.writeFile(wb, `Market_Sentiment_${new Date().toISOString().split('T')[0]}.xlsx`);
    }
  </script>
</body>
</html>