<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>DI Index – Объединённые данные</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { font-family: Arial, sans-serif; }
    .coin-container { margin-bottom: 40px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; position: sticky; top: 0; z-index: 1; cursor: pointer; }
    th:hover { background-color: #e6e6e6; }
    tr:hover { background-color: #e0f7fa; }
    tr.no-4h { background-color: #fff3e0; }
    tr.no-4h:hover { background-color: #ffe0b2; }
    caption { margin-bottom: 10px; font-size: 1.4em; font-weight: bold; }
    #error { color: red; font-weight: bold; margin-top: 20px; white-space: pre-wrap; }
    .symbol-selector { margin: 20px 0; }
    #loading { font-size: 1.2em; margin: 20px 0; }
    select[multiple] { min-width: 200px; height: 300px; }
    .loading-indicator { color: #666; font-style: italic; margin-left: 10px; }
    .control-buttons { margin: 10px 0; }
    .btn { 
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #6c757d;
      color: white;
    }
    .btn:hover {
      background-color: #5a6268;
    }
    .diff-highlight {
      background-color: rgba(255, 244, 229, 0.3);
    }
    .comparison-group {
      border-right: 2px solid #ddd;
    }
    thead tr th.group-header {
      text-align: center;
      background-color: #e9ecef;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>DI Index – Объединённые данные</h1>

  <!-- Селектор символов -->
  <div class="symbol-selector">
    <label for="symbols">Выберите криптовалюты:</label>
    <select id="symbols" multiple>
      <option value="BTC" selected>Биткоин (BTC)</option>
      <option value="ETH">Эфириум (ETH)</option>
      <option value="XRP">XRP (XRP)</option>
      <option value="BNB">BNB (BNB)</option>
      <option value="SOL">Solana (SOL)</option>
      <option value="ADA">Кардано (ADA)</option>
      <option value="CRO">Cronos (CRO)</option>
      <option value="DOGE">Dogecoin (DOGE)</option>
      <option value="TRX">TRON (TRX)</option>
      <option value="LEO">LEO Token (LEO)</option>
      <option value="HBAR">Hedera (HBAR)</option>
      <option value="LINK">Chainlink (LINK)</option>
      <option value="XLM">Stellar (XLM)</option>
      <option value="AVAX">Avalanche (AVAX)</option>
      <option value="SUI">Sui (SUI)</option>
      <option value="SHIB">Shiba Inu (SHIB)</option>
      <option value="LTC">Лайткоин (LTC)</option>
      <option value="BCH">Биткойн Кэш (BCH)</option>
      <option value="TON">Toncoin (TON)</option>
      <option value="OM">MANTRA OM (OM)</option>
      <option value="DOT">Polkadot (DOT)</option>
      <option value="BGB">Bitget Token (BGB)</option>
      <option value="HYPE">Hyperliquid (HYPE)</option>
      <option value="WBT">WhiteBIT Coin (WBT)</option>
      <option value="XMR">Монеро (XMR)</option>
      <option value="UNI">Uniswap (UNI)</option>
      <option value="APT">Aptos (APT)</option>
      <option value="NEAR">NEAR Protocol (NEAR)</option>
      <option value="AAVE">Aave (AAVE)</option>
      <option value="ETC">Ethereum Classic (ETC)</option>
    </select>
    <div class="control-buttons">
      <button onclick="selectAll()">Выбрать все</button>
      <button onclick="deselectAll()">Отменить выбор</button>
      <button onclick="loadSelectedData()">Загрузить данные</button>
    </div>
    <div id="loading" style="display: none;">
      Загрузка данных...<span class="loading-indicator"></span>
      <div id="progress"></div>
    </div>
  </div>

  <div id="error"></div>

  <div class="market-sentiment">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2>Общее настроение рынка</h2>
      <button class="btn btn-sm btn-secondary" onclick="downloadMarketSentimentExcel()">Экспорт в Excel</button>
    </div>
    <table class="sentiment-table">
      <thead>
        <tr>
          <th>Дата</th>
          <th>Количество бычьих сигналов</th>
          <th>Всего монет с данными</th>
          <th>Процент бычьих сигналов</th>
          <th>13 EMA (%)</th>
          <th>13 SMA (%)</th>
        </tr>
      </thead>
      <tbody id="sentimentTableBody">
      </tbody>
    </table>
  </div>

  <div id="tables-container">
    <!-- Таблицы будут добавлены здесь -->
  </div>

  <script>
    function formatValue(val) {
      return (val === null || isNaN(val)) ? '-' : Number(val).toFixed(2);
    }

    function show4hValues(values, date) {
        const existingModal = document.querySelector('#fourHourModal');
        if (existingModal) {
            existingModal.remove();
        }

        const modalHtml = `
        <div class="modal fade" id="fourHourModal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">4h значения за ${date}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Время</th>
                                    <th>Значение</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${values.map(entry => `
                                    <tr>
                                        <td>${entry.time}</td>
                                        <td>${formatValue(entry.value_new)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>`;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        $('#fourHourModal').modal('show');
        $('#fourHourModal').on('hidden.bs.modal', function (e) {
            $(this).remove();
        });
    }

    function get4hValuesForDate(row) {
      try {
        if (!row['4h_values_new']) {
          console.error("Missing 4h values arrays");
          return [];
        }

        return row['4h_values_new'].sort((a, b) => a.time.localeCompare(b.time));
      } catch (error) {
        console.error("Error in get4hValuesForDate:", error);
        return [];
      }
    }

    function createTable(symbol, data) {
      const container = document.createElement('div');
      container.className = 'coin-container';

      const exportButton = document.createElement('button');
      exportButton.className = 'btn btn-sm btn-secondary';
      exportButton.innerHTML = 'Экспорт в Excel';
      exportButton.onclick = () => downloadExcel(data, symbol);

      const headerDiv = document.createElement('div');
      headerDiv.style.display = 'flex';
      headerDiv.style.justifyContent = 'space-between';
      headerDiv.style.alignItems = 'center';
      headerDiv.style.marginBottom = '10px';

      const title = document.createElement('h3');
      title.textContent = `${symbol} - DI Index`;

      headerDiv.appendChild(title);
      headerDiv.appendChild(exportButton);
      container.appendChild(headerDiv);

      const table = document.createElement('table');
      table.setAttribute('data-sort-dir', 'asc');

      table.innerHTML = `
        <thead>
          <tr>
            <th rowspan="2">Дата</th>
            <th colspan="3" class="group-header">DI Компоненты</th>
            <th colspan="4" class="group-header">Расчет</th>
            <th rowspan="2">Close (Daily)</th>
          </tr>
          <tr>
            <th>Weekly</th>
            <th>Daily</th>
            <th>4h</th>
            <th>Total</th>
            <th>13 EMA</th>
            <th>30 SMA</th>
            <th>Trend</th>
          </tr>
        </thead>
        <tbody>
          ${data.map(row => {
            const values4h = JSON.stringify(get4hValuesForDate(row)).replace(/'/g, "\\'");
            return `
              <tr>
                <td>${row.time}</td>
                <td>${formatValue(row.weekly_di_new)}</td>
                <td>${formatValue(row.daily_di_new)}</td>
                <td style="cursor: pointer" onclick='show4hValues(${values4h}, "${row.time}")'>${formatValue(row['4h_di_new'])}</td>
                <td>${formatValue(row.total_new)}</td>
                <td>${formatValue(row.di_ema_13_new)}</td>
                <td>${formatValue(row.di_sma_30_new)}</td>
                <td>${row.trend_new ? (row.trend_new === 'bull' ? '<span style="color:green;">bull</span>' : '<span style="color:red;">bear</span>') : '-'}</td>
                <td>${formatValue(row.close)}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      `;

      container.appendChild(table);
      return container;
    }

    function downloadExcel(data, symbol) {
      const rows = [
        ['Дата', 
         'Weekly DI', 'Daily DI', '4h DI',
         'Total', '13 EMA', '30 SMA', 'Trend',
         'Close (Daily)']
      ];

      data.forEach(row => {
        rows.push([
          row.time,
          formatValue(row.weekly_di_new),
          formatValue(row.daily_di_new),
          formatValue(row['4h_di_new']),
          formatValue(row.total_new),
          formatValue(row.di_ema_13_new),
          formatValue(row.di_sma_30_new),
          row.trend_new || '-',
          formatValue(row.close)
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, symbol);
      XLSX.writeFile(wb, `${symbol}_DI_Index_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function selectAll() {
      const symbolsSelect = document.getElementById('symbols');
      for (let option of symbolsSelect.options) {
        option.selected = true;
      }
    }

    function deselectAll() {
      const symbolsSelect = document.getElementById('symbols');
      for (let option of symbolsSelect.options) {
        option.selected = false;
      }
    }

    async function loadSelectedData() {
      const loadingDiv = document.getElementById('loading');
      const progressDiv = document.getElementById('progress');
      const errorDiv = document.getElementById('error');
      const container = document.getElementById('tables-container');

      try {
        loadingDiv.style.display = 'block';
        errorDiv.textContent = '';
        container.innerHTML = '';

        const symbolsSelect = document.getElementById('symbols');
        const selectedSymbols = Array.from(symbolsSelect.selectedOptions).map(option => option.value);

        if (selectedSymbols.length === 0) {
          throw new Error('Пожалуйста, выберите хотя бы одну криптовалюту');
        }

        const batches = batchProcess(selectedSymbols, 3);
        let successCount = 0;
        let errorCount = 0;
        let allData = {};

        for (let i = 0; i < batches.length; i++) {
          const batch = batches[i];
          progressDiv.textContent = `Загрузка пакета ${i + 1} из ${batches.length} (${batch.join(', ')})...`;

          let retryCount = 0;
          const maxRetries = 3;

          while (retryCount < maxRetries) {
            try {
              const response = await fetch(`/api/di_index?symbols=${batch.join(',')}`);
              if (!response.ok) {
                throw new Error(`HTTP error: ${response.status}`);
              }

              const json = await response.json();
              Object.assign(allData, json);

              for (const [symbol, data] of Object.entries(json)) {
                if (Array.isArray(data)) {
                  container.appendChild(createTable(symbol, data));
                  successCount++;
                } else if (data.error) {
                  console.error(`Ошибка для ${symbol}:`, data.error);
                  errorDiv.textContent += `Ошибка для ${symbol}: ${data.error}\n`;
                  errorCount++;
                }
              }
              break;

            } catch (error) {
              retryCount++;
              if (retryCount === maxRetries) {
                console.error(`Error processing batch ${i + 1}:`, error);
                errorDiv.textContent += `Ошибка в пакете ${i + 1} (${batch.join(', ')}): ${error.message}\n`;
                errorCount += batch.length;
              } else {
                console.log(`Retry ${retryCount} of ${maxRetries} for batch ${i + 1}...`);
                await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
              }
            }
          }
        }

        if (Object.keys(allData).length > 0) {
          const sentimentData = calculateMarketSentiment(allData);
          updateSentimentTable(sentimentData);
        }

        progressDiv.textContent = `Загружено успешно: ${successCount} монет, с ошибками: ${errorCount} монет`;

      } catch (error) {
        console.error("Error loading data:", error);
        errorDiv.textContent = `Ошибка загрузки данных: ${error.message}`;
        progressDiv.textContent = '';
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    window.onload = loadSelectedData;

    function downloadMarketSentimentExcel() {
      const rows = [
        ['Дата', 'Количество бычьих сигналов', 'Всего монет с данными', 'Процент бычьих сигналов', '13 EMA (%)', '13 SMA (%)']
      ];

      const tbody = document.getElementById('sentimentTableBody');
      const tableRows = tbody.getElementsByTagName('tr');

      Array.from(tableRows).forEach(row => {
        const cells = row.getElementsByTagName('td');
        rows.push([
          cells[0].textContent,
          cells[1].textContent,
          cells[2].textContent,
          cells[3].textContent,
          cells[4].textContent,
          cells[5].textContent
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, "Market Sentiment");
      XLSX.writeFile(wb, `Market_Sentiment_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function calculateMarketSentiment(allData) {
      const sentimentByDate = {};

      // Собираем данные по датам
      for (const [symbol, data] of Object.entries(allData)) {
        if (!Array.isArray(data)) continue;

        data.forEach(row => {
          const date = row.time;
          if (!sentimentByDate[date]) {
            sentimentByDate[date] = { bullCount: 0, totalCount: 0 };
          }
          if (row.trend_new !== null) {
            sentimentByDate[date].totalCount++;
            if (row.trend_new === 'bull') {
              sentimentByDate[date].bullCount++;
            }
          }
        });
      }

      // Преобразуем в массив и считаем проценты
      const sortedData = Object.entries(sentimentByDate)
        .map(([date, data]) => ({
          date,
          bullCount: data.bullCount,
          totalCount: data.totalCount,
          percentage: (data.bullCount / data.totalCount * 100).toFixed(2)  // Процент бычьих сигналов
        }))
        .sort((a, b) => a.date.localeCompare(b.date));

      // Берем проценты для расчета средних
      const percentages = sortedData.map(item => parseFloat(item.percentage));
      const ma13 = [];
      const sma30 = [];
      const alpha = 2 / (13 + 1);  // Коэффициент для 13 EMA

      // Считаем EMA и SMA на основе процентов
      let emaSum = 0;
      let smaSum = 0;
      let smaCount = 0;

      for (let i = 0; i < percentages.length; i++) {
        if (isNaN(percentages[i])) {
          ma13.push(null);
          sma30.push(null);
          continue;
        }

        // Расчет EMA
        if (i === 0) {
          ma13.push(percentages[i]);
          emaSum = percentages[i];
        } else {
          const prevEMA = ma13[i - 1];
          if (prevEMA === null) {
            ma13.push(percentages[i]);
            emaSum = percentages[i];
          } else {
            const ema = (percentages[i] * alpha) + (prevEMA * (1 - alpha));
            ma13.push(ema);
            emaSum = ema;
          }
        }

        // Расчет SMA
        smaSum += percentages[i];
        smaCount++;
        if (smaCount > 30) {
          // Remove oldest value when we exceed window
          smaSum -= percentages[i - 30];
          smaCount = 30;
        }
        sma30.push(smaCount < 30 ? null : smaSum / 30);
      }

      // Добавляем значения EMA и SMA к результатам и сортируем в обратном порядке по дате
      return sortedData.map((item, index) => ({
        ...item,
        ma13: ma13[index] === null ? null : ma13[index].toFixed(2),  // 13 EMA
        sma13: sma30[index] === null ? null : sma30[index].toFixed(2)  // 30 SMA
      })).reverse();
    }

    function updateSentimentTable(sentimentData) {
      const tbody = document.getElementById('sentimentTableBody');
      tbody.innerHTML = sentimentData.map(row => `
        <tr>
          <td>${row.date}</td>
          <td>${row.bullCount}</td>
          <td>${row.totalCount}</td>
          <td>${row.percentage}%</td>
          <td>${row.ma13 !== null ? row.ma13 + '%' : '-'}</td>
          <td>${row.sma13 !== null ? row.sma13 + '%' : '-'}</td>
        </tr>
      `).join('');
    }
    function batchProcess(symbols, batchSize = 5) {
      const batches = [];
      for (let i = 0; i < symbols.length; i += batchSize) {
        batches.push(symbols.slice(i, i + batchSize));
      }
      return batches;
    }
  </script>
</body>
</html>