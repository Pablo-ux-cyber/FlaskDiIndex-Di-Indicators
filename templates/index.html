<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>DI Index – Объединённые данные</title>
  <style>
    body { font-family: Arial, sans-serif; }
    .coin-container { margin-bottom: 40px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; position: sticky; top: 0; z-index: 1; cursor: pointer; }
    th:hover { background-color: #e6e6e6; }
    tr:hover { background-color: #e0f7fa; }
    caption { margin-bottom: 10px; font-size: 1.4em; font-weight: bold; }
    #error { color: red; font-weight: bold; margin-top: 20px; white-space: pre-wrap; }
    .symbol-selector { margin: 20px 0; }
    #loading { font-size: 1.2em; margin: 20px 0; }
    select[multiple] { min-width: 200px; height: 300px; }
    .loading-indicator { color: #666; font-style: italic; margin-left: 10px; }
    .control-buttons { margin: 10px 0; }
  </style>
</head>
<body>
  <h1>DI Index – Объединённые данные</h1>

  <div class="symbol-selector">
    <label for="symbols">Выберите криптовалюты:</label>
    <select id="symbols" multiple>
      <option value="BTC" selected>Биткоин (BTC)</option>
      <option value="ETH">Эфириум (ETH)</option>
      <option value="XRP">XRP (XRP)</option>
      <option value="BNB">BNB (BNB)</option>
      <option value="SOL">Solana (SOL)</option>
      <option value="ADA">Кардано (ADA)</option>
      <option value="DOGE">Dogecoin (DOGE)</option>
      <option value="TRX">TRON (TRX)</option>
      <option value="LEO">LEO Token (LEO)</option>
      <option value="HBAR">Hedera (HBAR)</option>
      <option value="LINK">Chainlink (LINK)</option>
      <option value="XLM">Stellar (XLM)</option>
      <option value="AVAX">Avalanche (AVAX)</option>
      <option value="SUI">Sui (SUI)</option>
      <option value="SHIB">Shiba Inu (SHIB)</option>
      <option value="LTC">Лайткоин (LTC)</option>
      <option value="BCH">Биткойн Кэш (BCH)</option>
      <option value="TON">Toncoin (TON)</option>
      <option value="OM">MANTRA OM (OM)</option>
      <option value="DOT">Polkadot (DOT)</option>
      <option value="BGB">Bitget Token (BGB)</option>
      <option value="HYPE">Hyperliquid (HYPE)</option>
      <option value="WBT">WhiteBIT Coin (WBT)</option>
      <option value="XMR">Монеро (XMR)</option>
      <option value="UNI">Uniswap (UNI)</option>
      <option value="APT">Aptos (APT)</option>
      <option value="NEAR">NEAR Protocol (NEAR)</option>
      <option value="AAVE">Aave (AAVE)</option>
      <option value="ETC">Ethereum Classic (ETC)</option>
    </select>
    <div class="control-buttons">
      <button onclick="selectAll()">Выбрать все</button>
      <button onclick="deselectAll()">Отменить выбор</button>
      <button onclick="loadSelectedData()">Загрузить данные</button>
    </div>
    <div id="loading" style="display: none;">
      Загрузка данных...<span class="loading-indicator"></span>
      <div id="progress"></div>
    </div>
  </div>

  <div id="error"></div>
  <div id="tables-container">
    <!-- Таблицы будут добавлены здесь -->
  </div>

  <script>
    function formatValue(val) {
      return (val === null || isNaN(val)) ? '-' : Number(val).toFixed(2);
    }

    function selectAll() {
      const symbolsSelect = document.getElementById('symbols');
      for (let option of symbolsSelect.options) {
        option.selected = true;
      }
    }

    function deselectAll() {
      const symbolsSelect = document.getElementById('symbols');
      for (let option of symbolsSelect.options) {
        option.selected = false;
      }
    }

    function sortTable(table, columnIndex) {
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const isNumeric = columnIndex > 0;

      rows.sort((a, b) => {
        let aVal = a.cells[columnIndex].textContent;
        let bVal = b.cells[columnIndex].textContent;

        if (isNumeric) {
          aVal = aVal === '-' ? -Infinity : parseFloat(aVal);
          bVal = bVal === '-' ? -Infinity : parseFloat(bVal);
        }

        if (aVal < bVal) return -1;
        if (aVal > bVal) return 1;
        return 0;
      });

      const currentDir = table.getAttribute('data-sort-dir') === 'asc' ? 'desc' : 'asc';
      table.setAttribute('data-sort-dir', currentDir);

      if (currentDir === 'desc') {
        rows.reverse();
      }

      tbody.innerHTML = '';
      rows.forEach(row => tbody.appendChild(row));
    }

    function createTable(symbol, data) {
      const container = document.createElement('div');
      container.className = 'coin-container';

      const table = document.createElement('table');
      table.setAttribute('data-sort-dir', 'asc');

      const headers = [
        'Дата', 'Weekly DI Index', 'Daily DI Index', '4h DI Index',
        'Total', '13 EMA (Total)', '30 SMA (Total)', 'Trend', 'Close (Daily)'
      ];

      table.innerHTML = `
        <caption>${symbol} - DI Index</caption>
        <thead>
          <tr>
            ${headers.map((header, index) => 
              `<th onclick="sortTable(this.closest('table'), ${index})">${header}</th>`
            ).join('')}
          </tr>
        </thead>
        <tbody>
          ${data.map(row => `
            <tr>
              <td>${row.time}</td>
              <td>${formatValue(row.weekly_di)}</td>
              <td>${formatValue(row.daily_di)}</td>
              <td>${formatValue(row['4h_di'])}</td>
              <td>${formatValue(row.total_di)}</td>
              <td>${formatValue(row.di_ema_13)}</td>
              <td>${formatValue(row.di_sma_30)}</td>
              <td>${row.trend ? (row.trend === 'bull' ? '<span style="color:green;">bull</span>' : '<span style="color:red;">bear</span>') : '-'}</td>
              <td>${formatValue(row.close)}</td>
            </tr>
          `).join('')}
        </tbody>
      `;

      container.appendChild(table);
      return container;
    }

    async function loadSelectedData() {
      const loadingDiv = document.getElementById('loading');
      const progressDiv = document.getElementById('progress');
      const errorDiv = document.getElementById('error');
      const container = document.getElementById('tables-container');

      try {
        loadingDiv.style.display = 'block';
        errorDiv.textContent = '';
        container.innerHTML = '';

        const symbolsSelect = document.getElementById('symbols');
        const selectedSymbols = Array.from(symbolsSelect.selectedOptions).map(option => option.value);

        if (selectedSymbols.length === 0) {
          throw new Error('Пожалуйста, выберите хотя бы одну криптовалюту');
        }

        progressDiv.textContent = `Загрузка данных для ${selectedSymbols.length} монет...`;
        console.log('Загрузка данных для:', selectedSymbols.join(','));

        const response = await fetch(`/api/di_index?symbols=${selectedSymbols.join(',')}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const json = await response.json();
        console.log('Полученные данные:', json);

        let successCount = 0;
        let errorCount = 0;

        for (const [symbol, data] of Object.entries(json)) {
          if (Array.isArray(data)) {
            container.appendChild(createTable(symbol, data));
            successCount++;
          } else if (data.error) {
            console.error(`Error for ${symbol}:`, data.error);
            errorDiv.textContent += `Ошибка для ${symbol}: ${data.error}\n`;
            errorCount++;
          }
        }

        progressDiv.textContent = `Загружено успешно: ${successCount} монет, с ошибками: ${errorCount} монет`;

      } catch (error) {
        console.error("Ошибка загрузки данных:", error);
        errorDiv.textContent = `Ошибка загрузки данных: ${error.message}`;
        progressDiv.textContent = '';
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Загружаем данные при загрузке страницы
    window.onload = loadSelectedData;
  </script>
</body>
</html>